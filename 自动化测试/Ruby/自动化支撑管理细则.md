# 自动化支撑库管理细则

介绍自动化支撑库管理细则。

## 引导

给Impeller支撑库定义一个良好的规范，旨在解决当前支撑库管理中存在的各种问题。

当前发现的问题：

- 支撑库名称不规范
- 支撑库版本管理不规范
- 支撑库打包管理不规范
- 支撑库说明管理不规范
- 支撑库历史管理不规范
- 支撑库代码库管理不规范
- 支撑库缺乏帮助文档和设计文档

## 规范描述

### 支撑库名称

1. 支撑库名称建议命名为：
	```
	testlib-${pdu名称}-${用途}
	```
	
	这样的名称易于管理，容易记忆。
	比如：
	- 路由器部门支撑库就命名为`testlib-router`
	- VRP部门支撑库命名为`testlib-vrp`
	- VRP SMP支撑库命名为`testlib-vrp-smp`

	这些都是良好的命名方式。
	当前Gem服务器上的一些支撑库命名：
	- MibTest
	- Oet
	- UniteSpecialParament

	这些命名就不够好，我都不知道是哪个产品开发的…………
	
2. 支撑库的名称全部小些：
	支撑库名称统一采用小写字母，不采用大小写混合方式。这样符合ruby的传统规范。
	采用大小写混合方式的一些问题：
	- 可能导致支撑库重复加载
		举例说明：`testlib-VrpBase`这个支撑库，使用`require 'testlib-vrpbase'`和`require 'testlib-VrpBase'`都可以进行加载，不过会算作不同的支撑库，导致Vrpbase被加载2次，降低效率
	- 命令行安装时频繁进行大小写切换，安装不方便
	
	符合规范的命名：
	- `testlib-accessnet-base`
	- `tstlib-clear-config`

	不符合规范的命名：
	- `testlib-VrpBase`
	- `testlib-Vrppc`
	- `testlib-Vrp-L3`

3. 支撑库平台指定错误
	在当前很多产品支撑库对应的gemspec文件中，platform都指定为`mswin32`。
	```
	s.platform = 'mswin32'
	```
	这个会导致打包的支撑库只能运行在使用VC编译的Ruby上（Impeller用的`1.8.6`）。而开源届在Windows平台使用的RubyInstaller使用mingw编译，这样就导致平台不一致，存在以下问题：
	- 平台不一致，无法安装
	- 即使强制安装成功，运行时也会报无法找到对应的支撑库
	- 无法跨平台运行

	因此，规范中要求**gemspec文件中不指定平台版本**，以达到跨Ruby版本/跨平台安装运行的目的。以下情况除外：
	- 代码需要访问使用VC编译的C库，只能在Windows平台下运行

### 支撑库版本

我们当前的支撑库还没有一个统一的版本管理机制，比较混乱。统计了一下有几种方式：

- `x.x.x.x` 微软方式
- `x.x.x` ruby方式
- `2013.11.21` 日期方式
- `2013.11.21.1517` 混合方式
- `x.x.x.x.x` 五版本方式

Ruby从2.1开始版本编号采用语义化版本，当前已经被很多gem包采用，我们建议自己的支撑库也采用此方案。

一个语义化规则的例子：

- Version 2.1.0 -- 基线版本
- Version 2.2.0 -- 增加了一些兼容的新特性
- Version 2.2.1 -- 修复了一些Bug
- Version 2.2.2 -- 优化代码，没有增加新功能
- Version 2.3.0 -- 增加了新的功能（仍然保持向前兼容性）
- Version 3.0.0 -- 对外接口发生变化。基于2.x编写的代码可能无法运行。

语义化版本的好处：

- 规范API设计方式，考虑兼容性和版本问题
- 让版本兼容依赖变得简单
	在Ruby中，只需要gemspec文件中使用`~>`符号，即可进行兼容依赖。比如：
	```
	spec.add_runtime_dependency 'library', '~> 2.2'
	```
	
	等价于`['>=2.2','<3.0']`。
	
	但是注意：
	
	```
	spec.add_runtime_dependency 'library', '~> 2.2.0'
	```
	
	等价于`['>=2.2.0','<2.3.0']`。
	
	一般我们使用`~> x.x`的方式即可满足兼容性规则。
	
### 支撑库打包

当前很多支撑库打包是不规范的，举例说明：

- 缺少必须说明文件和历史文件
	很多支撑库打包后，没有`readme.txt`和`history.txt`说明，历史版本看不到，开发者看不到，安装后一头雾水，不知道出了问题找谁。
- 将无关文件打入支撑库
	我定位支撑库问题时，发现`testlib-acessnet-1.1.0-mswin32.gem`文件大小高达92M。为什么会这么大呢？
	1. 支撑库里面竟然包含了一个44M的`testlib-accessnet-2.0.0-x86-mswin32.gem`文件。gem文件是不推荐打在安装包里面的，造成安装包体积庞大，对实际执行来说也没啥用处。
	2. 支撑库中包含了完整的tcl83库，接近36M。这个建议使用testlib-tclpkg，或者单独提取出一个gem包。
	3. 内部放置了很多db/xls/word文件。哪些文件是运行时必须的，哪些文件是偶尔才运行。支撑库不是大一统文件，一些辅助工具建议放到另外的支撑库或者单独的SVN上管理。
- 缺少spec或者test测试文件
	有时候支撑库的单元测试/系统测试文件是相当有用的。很多时候支撑库的文档不是很完善，单元测试/系统测试代码实际上是对文档的一个很好补充，可供其他用户参考。当然如果你的支撑库没有测试代码…………囧
	
支撑库打包规范

1. 打包一般包含如下目录和文件
	- `lib`：程序库代码
	- `bin`:  命令行接口‘
	- `spec/test`: 测试脚本
	- `readme.md`/`readme.txt`：说明文件
	- `history.md`/`history.txt`：历史修改记录
	- `rakefile`: rake构建任务
2. 禁止在支撑库中包含`.svn`/`.git`目录
3. 禁止在支撑库中包含其他不相关的二进制文件
4. 每次发布前，请更新版本和历史修改记录
5. 版本号修改请参考之前的支撑库版本修改建议
6. 打包完成后上传到`ftp://atc-gems.huawei.com/publish`


```ruby
require 'rubygems'

spec = Gem::Specification.new do |s|
	s.name = '支撑库名称（小写英文名称）'
	s.version = '支撑库版本'
	s.date = Time.new.strftime('%Y-%m-%d')
	s.summary = '支撑库描述'
	s.homepage = '支撑库网站'
	s.autorequire = 'gem包自动加载的文件'
	s.require_path = 'lib'
	s.has_rdoc = false
	s.required_ruby_version = Gem::Version::Requirement.new(">=1.8.0")
	s.authors = ['支撑库作者']
	
	files = Dir.glob("{doc,lib,test,spec,bin}/**/*")
	files.delete_if {|f| /vssver\s.scc/i =~ f}
	files.delete_if {|f| f =~ /\.svn[\\\]/i}
	files << 'readme.txt'
	files << 'history.txt'
	files << 'rakefile'
	
	s.files = files
end
```


### 支撑库说明
支撑库需要有自己的readme说明文件，格式可以采用普通文本或者Markdown。
在支撑库说明中，一般填写以下内容：

#### 简介
简要说明此支撑库的用途。

比如：

```
testlib-topo是用于根据用户逻辑组网文件(env/enx)和对设备的约束要求(topolimit)，从指定的测试床(testbed)中选择符合设备要求的算法。支持动态环境（物理交换机）和静态环境查找。
```

#### 支持特性
说明此支撑库支持哪些功能。

比如：

```
vrpbase当前支持功能：

- CLI命令行数据收发/CLI命令行模板
- CLI命令行视图自动切换
- Netconf命令行数据收发/Netconf命令行模板
- telnet/stelnet/ssh/ftp/watir/rapi/mml通讯协议
```

#### 环境需求
运行此支撑库需要的环境需求。比如Ruby版本，Rubygems版本，依赖的支撑库等。

比如：

```
- Ruby >= 2.0
- Rubygems >= 2.1.0
- testlib-topo ~> 2.0
- minienv ~> 1.0
```

#### 作者
支撑库原始作者和当前维护人员，越近的维护人员，顺序越往后。

比如：

```
原始作者：z00123009

维护人员：
- h00256547
- h00256487
```

#### 许可证
如果支撑库已经开源，可以将许可证也写上。一般都是：

```
(The MIT License) Copyright(c) 2014 Huawei.
```

#### 支撑库修改历史
在`history.txt`或者`history.md`文件中记录每次版本的修改历史。

推荐格式：

```
## 版本 / 修改时间
- 本次修改说明1
- 本次修改说明2
- 本次修改说明3
```

vrpbase历史修改记录参考：
```
## 1.6.33 / 2014-06-23
- 新增get_template插件接口，用于自定义模板的搜索过程

## 1.6.32 / 2014-05-29
- 替换用户输入字符串的格式为\\r\\n为\r\n

## 1.6.31 / 2014-05-27
- 调整标准化函数的调用次数判断，以解析结果中field数据为准

## 1.6.30 / 2014-05-23
- 特殊兼容mml模式下发`0x1a`，如果下发是Ctrl+Z，那么不判断回显包含此数据
- 修正 `enable_rs_padding` API设置值总是:space问题
```

### 支撑库代码库管理
支撑库代码库（SVN/Git/Hg）中，代码库应该只存放跟支撑库代码相关的文件和设计文档，一些中途产生的临时文件不要上传到配置库。
- 打包生成的gem文件不要尚酷。gem文件本来就可以通过代码库，打出任何一个版本的gem包，因此历史打包的gem文件不要上库。
- 一些庞大的二进制文件不建议上库，考虑使用其他方式存放（比如ftp或者网络共享文件夹）
- 支撑库运行时需要的一些小exe工具必须上库，保证运行稳定性


### 帮助文档和设计文档
支撑库可以在doc目录中提供对应的帮助文档和设计文档。如果帮助文档和设计文档比较庞大，可以将其放在hi3ms或者其他网站上，在readme中提供链接供用户访问。

花点时间写一些帮助文档和设计文档吧，在以后它会为你节省大量的用户咨询时间！