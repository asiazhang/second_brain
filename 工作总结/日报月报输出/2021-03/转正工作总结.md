# 转正工作总结

- 姓名：pinhenzhang(张恒)👨
- 所在组：测试开发一组
- 导师: rimon

---

# 简单工作经历

2008~2020年，在华为一直从事效能工具开发💻

---

- 自动化测试工具开发(桌面/Web/服务端)
- CI构建工具开发
- DevOps工具开发

---

# 主要工作

1. 基座微服务化
2. 基座适配QCI SaaS化

---

# 基座微服务化

--- 

## 背景

Coding基座当前存在以下问题：
1. 单体应用，难以维护和定位
2. 包含太多职责，出问题导致整个系统不可用

---

![[core_mircoservice.png]]

---

## notify服务

- 负责实现`coding-app-notify`服务，90%的代码覆盖率
- 顺带实现了简单的coding全局公告功能
- 已正式上线

---

## 收获

1. 了解了基座的构成
2. 了解了如何使用流水线发布服务
3. 了解了整套监控、日志、Tracing体系

---

## 不同的方案

我们之前进行微服务化的流程，跟当前有些不同：

1. 分析流量最高的模块
2. 分析问题最多的模块
3. **进行代码迁移（基本上复制到新项目，不做大改动）**
4. 新微服务上线
5. 老服务代码下线

---

![[app_infra.png]]

--- 

## 差异点

1. 微服务并不限制表访问
2. 从API直接到数据库，无中间层

--- 

## Everything has Tradeoff

---

### 当前方案(A)

- ✅优点
	- 单一职责原则
	- 架构清晰
	- 以接口屏蔽底层差异
- ❌缺点
	- 调用链路可能较长，出问题概率会大一点
	- 如果涉及到同时需要访问多个表的逻辑，需要分次调用，性能可能会受影响
	- 工作量较大

---

### 另外方案(B)

- ✅优点
	- 工作量小，改动不多
	- 没有中间层，问题概率会小一点
	- 性能上可能有优势
- ❌缺点
	- 直接依赖底层数据库等基础设施
	- 职责可能违反单一性原则

---

### 个人更倾向于方案B

以数据中台自定义报表举例

![[boss.png|400]]

---

#### 主要功能包含2部分

- 面向老板的管理报表
- 面向工程师的自定义报表（可自己写SQL）

#### 问题

工程师写的SQL太多慢查询，把连接池用完了，结果管理报表显示不出来😅

---

# 基座适配QCI SaaS化

---

### 背景

- OA版本的QCI迁移到SaaS上对外开放使用
- Cloud Native
- 增强Devops竞争力

---

### 差异

Coding SaaS和OA的基座，当前存在诸多差异：

- 接口名称不同
- 输入参数不同
- 返回参数不同
- 缺少接口

---

### 适配层

计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决🐶

--- 

#### gRPC适配层

![[coding_saas-adapter.png]]

---

#### 优点/缺点

- ✅优点1：无需QCI做修改，尽量透明迁移
- ✅优点2：也无需SaaS团队大修改
- ❌缺点1：临时性解决方案
- ❌缺点2：有部分接口存在性能问题（分页查询/用户GK）

---

#### 现状

- 适配24个gRPC接口完成✅
- 已经部署到staging环境联调

---

# 困难/改进

1. Coding SaaS遗留代码问题
2. 发布调测效率低⬇️
3. SaaS化问题

---

## Coding SaaS遗留代码

- 很多代码在OA版本已经不适用，但是没有删除（前端/后端特别是基座）
- 建议逐步清理

---
 
### 代码量

```
───────────────────────────────────────────────────────────────────────────
Language                 Files       Lines     Blanks    Comments      Code
───────────────────────────────────────────────────────────────────────────
Java                      1977      203456      31943       18067    153446
Markdown                    23        1114        342           0       772
Properties File              4        2812        245         246      2321
Gradle                       1         130         16           2       112
License                      1          19          3           0        16
Plain Text                   1          70          0           0        70
Shell                        1         101         10           2        89
XML                          1         777         90          44       643
gitignore                    1           1          1           0         0
───────────────────────────────────────────────────────────────────────────
Total                     2010      208480      32650       18361    157469
───────────────────────────────────────────────────────────────────────────
```

---

## 发布调测效率低

- 当前testing只能单分支发布
- 线上测试环境经常被别人冲掉
- 前端/后端都存在此问题，调测效率低

---

## 问题本质

- 多个功能特性并行开发，都想进行测试
- 不支持自动集成分支模式

---

## 发布区流水线图

![[publish_area.png|500]]

---

## SaaS化问题

1. 原子能力尽可能自满足

---

### 网关鉴权

![[qci_more_self_dep.png]]

以网关为例，如果将鉴权逻辑放到QCI自身服务中，是否适配部署会简单些？

---


# 未来规划

1. qci支持saas完善
2. 原子能力提取
3. 其他DevSecOps能力

---

## QCI支持SaaS进一步完善

当前采用适配器只是短期方案，长期方案来看OA和SaaS版本底座尽量统一，减少差异化的部分。

---

## 原子能力提取

OA版本优秀能力原子化

- 静态代码检查
- 开源漏洞扫描能力

---

## 开源漏洞扫描能力

在CI构建阶段，根据当前的构建工具信息，识别依赖的三方库是否有有漏洞(Java/nodeJS/Go/Python)。

- DevSecOps的基础能力之一
- 仅扫描依赖库，不扫描代码
- 上家公司/Gitlab/Github都具备此能力


---

## Thanks